---
title: "How to use the *rSPAMM* package for assessment of harp and hooded seals populations"
author: "T. A. Øigård and M. Biuw"
date: "`r Sys.Date()`" 
output: rmarkdown::html_vignette
vignette: >
    %\VignetteIndexEntry{How to use the *rSPAMM* package for assessment of harp and hooded seal populations}
    %\VignetteEngine{knitr::rmarkdown}
    \usepackage[itf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Overview
The purpose of this vignette is to show how to use the *rSPAMM* package for assessment of various harp and hooded seal populations. It will guide you through the model fitting, obtaining estimated quantities, finding and exploring, various catch options, how to structure the data set, and how to visualize the modelled population dynamics. We also present the model which is used (Martin: burde dette være appendix istedet eller er det OK slik?).

## The population dynamics model

## Installation of the *rSPAMM* package and how to update it
The most recent version of *rSPAMM* is hosted on a git repository at [https://github.com/NorskRegnesentral/rSPAMM.git](https://github.com/NorskRegnesentral/rSPAMM.git).

We recommend to use the RStudio software and the instructions assumes that the user makes use of this software. More advanced users not using RStudio will be able to follow the installation procedure described below and do it manually. In order to download the rSPAMM package you han download it from Git Hub by cloning the Git repository. In RStudio you do the following steps:

* Select: File -> New project
* Select: Version control
* Select: Git
* In the "Repository URL" box type: https://github.com/NorskRegnesentral/rSPAMM.git
* Fill in the rest of the boxes depending on where you want the package stored on your computer
* In the console window type:
```{r eval = FALSE}
source("install_rSPAMM.R")
```

The *rSPAMM* package is now installed. To load the package type
```{r eval = FALSE}
library(rSPAMM)
```

If you want to update the package to the most recent version you find the Git menu in the panel to the top right corner of RStudio. From there you click on the Pull button and then it will download the most recent version of *rSPAMM*. You have to install the package again by sourcing the installation script again.

## Data used by the population dynamics model and how to load them

In this section we will describe what type of data is used, which data files are needed, and the format the various data are stored.

### Data files
All data that is described below will be loaded and used by the model to fit the population dynamics. All data sets are found in the *Data/* folder separated into folders for each population.

#### Catch data
Catch data are found in the file *catch_data.dat* and the content of the file looks like this:
```{r echo = FALSE}
catch_data <- read.table(paste("Data/harpeast/catch_data.dat",sep = ""),header = FALSE)
head(catch_data)
```
The first column contains the year, the seccond column contains the catch of pups, and the third column contains the catch of the 1+ population.

#### Pup production estimates
Estimated pup production is found in the file *pup_production.dat*. The content of the file looks like this: 
```{r echo = FALSE}
pup_production <- read.table(paste("Data/harpeast/pup_production.dat",sep = ""),header = FALSE)
pup_production
```
In the first column you see the survey year, in the seccond column you see the estimated pup production, and in the third the estimated CV of that survey is given.

#### Fecundity data
Fecundity data is found in the *fecundity.dat* file. The content of the file looks like this:
```{r echo = FALSE}
fecundity <- read.table(paste("Data/harpeast/fecundity.dat",sep = ""),header = FALSE)
fecundity
```
In the first column you have the year for when the fecundity is estimated, in the seccond column you have the estimated fecundity, and in the thirst column you have the estimated standard error of the fecundity estimate.

#### Birth ogive
In the files *wgharp.ogi* and *wgharp.ogp* you find the birth ogive data, and the from which time periods the birth ogive curves applies for. The content of the *wgharp.ogi* looks like

```{r echo = FALSE}
# Birth ogives for different periods
Pdat <- read.table(paste("Data/harpeast/wgharp.ogi",sep = ""),sep = "",header = TRUE)
# Which periods the various birth ogives applies to
Pper <- read.table(paste("Data/harpeast/wgharp.ogp",sep = ""),header = TRUE)
Pdat
```
In the first column the age group is listed and in the following columns a birth ogive curve is listed for a given period. Every time a new birth ogive estimated is available, a new column is added. The content of the *wgharp.ogp* looks like 
```{r echo = FALSE}
Pper
```
The first column denotes the start of the time period a given birth ogive curve applies for, and the second column denotes the end of the time period the birth ogive curve is valid. The reason for this is that usually data for several years are pooled together when estimating the birth ogive curve in order to ensure enough data to obtain a reasonable estimated of the birth ogive. Note that the number of rows in the *wgharp.ogp* file corresponds to the number of columns in the *wgharp.ogi* file (minus 1 since one column represents the age group).

#### Priors used
Priors used for the various parameters are specified in the *priors.dat* file. The content of the file looks like this:

```{r echo = FALSE}
priors <- read.table(paste("Data/harpeast/priors.dat",sep = ""),header = FALSE)
priors
```
Each row specify mean and the standard deviation of a Gaussian prior used for a given parameter. In the first colum the mean value is found and in the second column the standard deviation is found. In the first row the prior distribution of the initial population size $K$ is specified, in the seccond row the prior distribution of the 1+ mortality $M$ is specified, and in the third row the prior distribution of the pup mortality $M_0$ is specified.



### Loading the data
In order to load the data you have to specify which population you want to load the data for. The various alternatives are *harpeast*, *harpwest*, and *hooded* (which is the hooded seal population in the West Ice - the ice along the east coast of Greenland). In the examples that follows we will use the *harpeast* population. To load the data used you run the following command:
```{r eval = FALSE}
data <- load.data(population = "harpeast")
```
To explore the data object you can
```{r eval = TRUE,echo=FALSE}
library(rSPAMM)

#Set population
population = 'harpeast'
#Load the data
data <- load.data(population = population)
```

```{r eval = TRUE}
names(data)
```
The data object is a list and you can further explore the actual values used by e.g.,
```{r}
data$Amax

data$pupProductionData

```


## Parameters to be estimed and how to load them
As briefly mentioned earlier the population dynamics model is described by three parameters. The initial population size $K$, the mortality of the 1+ population $M$, and the pup mortality $M_0$. The initial population size is the population size for the year the model is fit from, and this is determined by the availability of the catch data. The earliest catch data is from 1946, so the model is fit from 1946 and up to present. It also predicts the population dynamics into the future, and this is default set to 15 years. 

To load the initial values of the parameters to be estimated run:
```{r eval = TRUE}
parameters <- load.initial.values(population = population)
```
The parameters object is also a list and the content looks like this for the *harpeast* population
```{r eval = TRUE}
parameters
```
Here *logK* is the log transformed initial population size, *M0tilde* is the logit transformed pup mortality, and *Mtilde* is the logit transformed 1+ mortality (seals of age 1 and greater). The reason that transformed parameters are estimated instead of the non transformed parameters is that the log transformation of the initial population ensures that the model provides a stricktly positive estimate of the initial population. The logit tranformation of the mortalities ensures that the estimates are bounded between 0 and 1. 

## Model fitting and obtaining estimates
The model is implemented in the Template Model Builder framework and makes use of the *TMB* R package. This means that the code for model is written in C++ and will thus have to be compiled first time you try to fit a model. It will also have to be recompiled if the model is updated. This is not something the user need to worry about. When installing the *rSPAMM* package the *TMB* package and all dependencies should also be installed automatically, and when loading the model it automatically checks wether the C++ code needs to be compiled or not. If it needs to be compiled it is done automatically.

### Loading the model object and fitting the model
When compiling the model a model object, a *.dll* file is created and this has to be loaded first. This is done by running:

```{r eval = FALSE}
obj = load.model.object(dat = data,par = parameters)
```
```{r eval = TRUE, echo = FALSE,include = FALSE}
obj = load.model.object(dat = data,par = parameters,template='harps_and_hoods_population_model2')
```
The *obj* object is an object containing the log-likelihood value and the gradient for the initial parameters. This is used by fitting the model using an ordinary built in optimization routine in R. The default optimization routine used is *nlminb*, but this can be changed. (MARTIN: bør vi legge inn en mulighet til å endre optimiseringsrutiner). The content of the *obj* object looks like this:
```{r}
names(obj)
```
The value of the log likelihood and the gradient of the log likelihood for a given set of parameters can be explored by
```{r}
obj$fn()

obj$gr()
```

To fit the model run:

```{r eval = FALSE}
opt <- run.model(object = obj)
```

When the model is fitted some key information will be written to screen. This key information show whether the model converged, what type of convergence and estimates of the parameters that describes the modelled population dynamics. It might look like this:
```{r echo = FALSE}
opt <- run.model(object = obj)
```



### Obtaining the estimated quantities
In addition to the estimated parameters needed to describe the modelled population dynamics of a population the model fit also provides the user with other relevant quantities. The Table below lists the various quantities obtained.

----------------------------------------------------
Variable name           Description
-----------------       ----------------------------
rep                     Check it out

rep.matrix              Check

rep.names               check

indN0                   Indexes of where the fitted pup population is found in the
                        rep.matrix
                     
indN1                   Indexes for the modelled 1+ population

indNtot                 Indexes for  the total population

indD1                   Index for the estimated of D 

indD1new                Index for the estimated D1new

indN0Current            Index for the modelled pup abundance in the current year

indN1Current            Index for the modelled 1+ abundance in the current year

indNtotCurrent          Index for the modelled total population in the current year                     

years                   The years the model is fitted for

Kest                    Estimated initial population size

Kest.sd                 Standard deviation of the initial population size

Mest                    Estimated 1+ mortality

Mest.sd                 Standard deviation of the 1+ mortality

M0est                   Estimated pup mortality

M0est.sd                Standard deviation of the estimated pup mortality

D1                      Estimated depletion coefficient

D1New                   Estimated of depletion coefficient

N0Current               Estimated pup abundance for the current year

N1Current               Estimated 1+ abundance for the current year

NtotCurrent             Estimated total abundance for the current year

D1.sd                   Standard deviation of estimated D

D1New.sd                Standard deviation of estimated D

N0Current               Standard deviation of current pup abundance

N1Current               Standard deviation of current 1+ abundance

NtotCurrent             Standard deviation of current total abundance
-------------------------------------------------

The model results can be obtained by running:
```{r eval = FALSE}
res <- model.results(dat = data,object = obj,optimized = opt)
```
```{r echo = FALSE,include = FALSE}
res <- model.results(dat = data,object = obj,optimized = opt)
```
The *res* object is a list containing all the estimates of the quantities listed in the Table above.

```{r}
names(res)
```

A table for the most interesting quantities needed can be made by running:
```{r eval = FALSE}
partab <- par.table(results=res, dat=data, tab2flex=FALSE) 
```
```{r include = FALSE}
partab <- par.table(results=res, dat=data, tab2flex=FALSE) 
```
```{r}
partab 
```


## Exploring various catch options

## Visualize the modelled population dynamics

## Short summary of an actual assessment of the population dynamics for a given population
